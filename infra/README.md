# AWS Elastic Beanstalk Infrastructure

## Pre-requisites

- Terraform;
- AWS Account;
- Create an user on IAM with the following permissions: `AmazonEC2FullAccess`, `AmazonS3FullAccess`, `AdministratorAccess-AWSElasticBeanstalk`, `AWSAppRunnerServicePolicyForECRAccess`, `EC2InstanceProfileForImageBuilderECRContainerBuilds`;
- Create IAM Role for `EC2` as `AWS Service` and attach `AWSElasticBeanstalkWebTier`, `AWSElasticBeanstalkMulticontainer`, `AWSElasticBeanstalkWorkerTier` and `AmazonEC2ContainerRegistryReadOnly` policies to it. The IAM role should be named as `aws-elasticbeanstalk-ec2-role`.

## Running commands

```shell
export AWS_ACCESS_KEY_ID="<your-access-key-here>"
export AWS_SECRET_ACCESS_KEY="<your-secret-key-here>"
export AWS_REGION="<your-aws-region-here>"
```

```shell
terraform init
```

```shell
terraform plan -out plan-output
```

```shell
terraform apply plan-output
```

## Troubleshooting

Follow [these steps](https://stackoverflow.com/questions/4742478/ssh-to-elastic-beanstalk-instance) to configure your key-pair to remotely access your `ElasticBeanstalk` EC2 instance through `ssh`. 

```shell
ssh -i <your-private-key>.pem ec2-user@<ec2-instance-name>.compute-1.amazonaws.com
```

> **NOTE:** navigate to your EC2 instance in the AWS console and you'll see a `Connect` button at the top right corner. Click on it and then go to the `SSH client` tab, you'll see a command example on how to access it remotely.  

The `docker-compose` file is placed in the following path of the EC2 instance:

```shell
/var/app/current/docker-compose.yml
```

## Reverse Proxy

`Nginx` is configured in the following path of the host EC2 machine:

```shell
cat etc/nginx/nginx.conf
```

## Deploy

[According to AWS](https://docs.aws.amazon.com/elasticbeanstalk/latest/dg/create_deploy_docker.container.console.html#docker-env-cfg.env-variables), it's allowed to configure environment variables following one of these approaches:

- Add the `.env` file generated by Elastic Beanstalk to the `env_file` configuration option in the `docker-compose.yml` file.

- Directly define the environment variables in the `docker-compose.yml` file.

For some reason, I could only configure environments following the first approach (`.env` file). To upload both files you must put them in the same compressed `.zip` folder, take a look at the [deploy-folder.zip]() example, and deploy this compressed folder instead of a single `docker-compose.yml` file.

[Reference](https://docs.aws.amazon.com/elasticbeanstalk/latest/dg/single-container-docker-configuration.html#docker-configuration.no-compose)